From: Shengjing Zhu <zhsj@debian.org>
Date: Mon, 21 Feb 2022 00:53:36 +0800
Subject: Disable opentelemetry

go.opentelemetry.io/contrib is not packaged.

Forwarded: not-needed
---
 cmd/containerd/builtins.go |  1 -
 services/server/server.go  | 14 ++------------
 2 files changed, 2 insertions(+), 13 deletions(-)

Index: src/cmd/containerd/builtins.go
===================================================================
--- src.orig/cmd/containerd/builtins.go
+++ src/cmd/containerd/builtins.go
@@ -37,5 +37,4 @@ import (
 	_ "github.com/containerd/containerd/services/tasks"
 	_ "github.com/containerd/containerd/services/version"
 	_ "github.com/containerd/containerd/services/warning"
-	_ "github.com/containerd/containerd/tracing/plugin"
 )
Index: src/services/server/server.go
===================================================================
--- src.orig/services/server/server.go
+++ src/services/server/server.go
@@ -37,11 +37,9 @@ import (
 
 	"github.com/containerd/ttrpc"
 	metrics "github.com/docker/go-metrics"
-	grpc_middleware "github.com/grpc-ecosystem/go-grpc-middleware"
 	grpc_prometheus "github.com/grpc-ecosystem/go-grpc-prometheus"
 	v1 "github.com/opencontainers/image-spec/specs-go/v1"
 	bolt "go.etcd.io/bbolt"
-	"go.opentelemetry.io/contrib/instrumentation/google.golang.org/grpc/otelgrpc"
 	"google.golang.org/grpc"
 	"google.golang.org/grpc/backoff"
 	"google.golang.org/grpc/credentials"
@@ -137,15 +135,8 @@ func New(ctx context.Context, config *sr
 	}
 
 	serverOpts := []grpc.ServerOption{
-		grpc.StatsHandler(otelgrpc.NewServerHandler()),
-		grpc.StreamInterceptor(grpc_middleware.ChainStreamServer(
-			grpc.StreamServerInterceptor(grpc_prometheus.StreamServerInterceptor),
-			streamNamespaceInterceptor,
-		)),
-		grpc.UnaryInterceptor(grpc_middleware.ChainUnaryServer(
-			grpc.UnaryServerInterceptor(grpc_prometheus.UnaryServerInterceptor),
-			unaryNamespaceInterceptor,
-		)),
+		grpc.UnaryInterceptor(grpc_prometheus.UnaryServerInterceptor),
+		grpc.StreamInterceptor(grpc_prometheus.StreamServerInterceptor),
 	}
 	if config.GRPC.MaxRecvMsgSize > 0 {
 		serverOpts = append(serverOpts, grpc.MaxRecvMsgSize(config.GRPC.MaxRecvMsgSize))
