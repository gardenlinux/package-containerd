From: Shengjing Zhu <zhushengjing@cambricon.com>
Date: Mon, 21 Feb 2022 00:50:59 +0800
Subject: Revert "Use insecure.NewCredentials instead of grpc.WithInsecure"

This reverts commit 2ee3ce510cf26d5eb400fac118aeeec5c20ed83f.

Need golang-google-grpc-dev v1.34.0

Forwarded: not-needed
---
 client.go                            | 3 +--
 cmd/containerd/command/publish.go    | 3 +--
 integration/main_test.go             | 6 +-----
 integration/remote/remote_image.go   | 7 +------
 integration/remote/remote_runtime.go | 7 +------
 services/server/server.go            | 3 +--
 6 files changed, 6 insertions(+), 23 deletions(-)

Index: containerd/client.go
===================================================================
--- containerd.orig/client.go
+++ containerd/client.go
@@ -64,7 +64,6 @@ import (
 	"golang.org/x/sync/semaphore"
 	"google.golang.org/grpc"
 	"google.golang.org/grpc/backoff"
-	"google.golang.org/grpc/credentials/insecure"
 	"google.golang.org/grpc/health/grpc_health_v1"
 )
 
@@ -118,7 +117,7 @@ func New(address string, opts ...ClientO
 		}
 		gopts := []grpc.DialOption{
 			grpc.WithBlock(),
-			grpc.WithTransportCredentials(insecure.NewCredentials()),
+			grpc.WithInsecure(),
 			grpc.FailOnNonTempDialError(true),
 			grpc.WithConnectParams(connParams),
 			grpc.WithContextDialer(dialer.ContextDialer),
Index: containerd/cmd/containerd/command/publish.go
===================================================================
--- containerd.orig/cmd/containerd/command/publish.go
+++ containerd/cmd/containerd/command/publish.go
@@ -32,7 +32,6 @@ import (
 	"github.com/urfave/cli"
 	"google.golang.org/grpc"
 	"google.golang.org/grpc/backoff"
-	"google.golang.org/grpc/credentials/insecure"
 )
 
 var publishCommand = cli.Command{
@@ -100,7 +99,7 @@ func connect(address string, d func(goco
 	}
 	gopts := []grpc.DialOption{
 		grpc.WithBlock(),
-		grpc.WithTransportCredentials(insecure.NewCredentials()),
+		grpc.WithInsecure(),
 		grpc.WithContextDialer(d),
 		grpc.FailOnNonTempDialError(true),
 		grpc.WithConnectParams(connParams),
Index: containerd/integration/main_test.go
===================================================================
--- containerd.orig/integration/main_test.go
+++ containerd/integration/main_test.go
@@ -47,7 +47,6 @@ import (
 	"github.com/stretchr/testify/require"
 	exec "golang.org/x/sys/execabs"
 	"google.golang.org/grpc"
-	"google.golang.org/grpc/credentials/insecure"
 	runtime "k8s.io/cri-api/pkg/apis/runtime/v1"
 )
 
@@ -546,10 +545,7 @@ func RawRuntimeClient() (runtime.Runtime
 	}
 	ctx, cancel := context.WithTimeout(context.Background(), timeout)
 	defer cancel()
-	conn, err := grpc.DialContext(ctx, addr,
-		grpc.WithTransportCredentials(insecure.NewCredentials()),
-		grpc.WithContextDialer(dialer),
-	)
+	conn, err := grpc.DialContext(ctx, addr, grpc.WithInsecure(), grpc.WithContextDialer(dialer))
 	if err != nil {
 		return nil, fmt.Errorf("failed to connect cri endpoint: %w", err)
 	}
Index: containerd/integration/remote/remote_image.go
===================================================================
--- containerd.orig/integration/remote/remote_image.go
+++ containerd/integration/remote/remote_image.go
@@ -39,7 +39,6 @@ import (
 	"time"
 
 	"google.golang.org/grpc"
-	"google.golang.org/grpc/credentials/insecure"
 	"k8s.io/klog/v2"
 
 	internalapi "github.com/containerd/containerd/integration/cri-api/pkg/apis"
@@ -65,11 +64,7 @@ func NewImageService(endpoint string, co
 	ctx, cancel := context.WithTimeout(context.Background(), connectionTimeout)
 	defer cancel()
 
-	conn, err := grpc.DialContext(ctx, addr,
-		grpc.WithTransportCredentials(insecure.NewCredentials()),
-		grpc.WithContextDialer(dialer),
-		grpc.WithDefaultCallOptions(grpc.MaxCallRecvMsgSize(maxMsgSize)),
-	)
+	conn, err := grpc.DialContext(ctx, addr, grpc.WithInsecure(), grpc.WithContextDialer(dialer), grpc.WithDefaultCallOptions(grpc.MaxCallRecvMsgSize(maxMsgSize)))
 	if err != nil {
 		klog.Errorf("Connect remote image service %s failed: %v", addr, err)
 		return nil, err
Index: containerd/integration/remote/remote_runtime.go
===================================================================
--- containerd.orig/integration/remote/remote_runtime.go
+++ containerd/integration/remote/remote_runtime.go
@@ -40,7 +40,6 @@ import (
 	"time"
 
 	"google.golang.org/grpc"
-	"google.golang.org/grpc/credentials/insecure"
 	"k8s.io/klog/v2"
 
 	internalapi "github.com/containerd/containerd/integration/cri-api/pkg/apis"
@@ -74,11 +73,7 @@ func NewRuntimeService(endpoint string,
 	ctx, cancel := context.WithTimeout(context.Background(), connectionTimeout)
 	defer cancel()
 
-	conn, err := grpc.DialContext(ctx, addr,
-		grpc.WithTransportCredentials(insecure.NewCredentials()),
-		grpc.WithContextDialer(dialer),
-		grpc.WithDefaultCallOptions(grpc.MaxCallRecvMsgSize(maxMsgSize)),
-	)
+	conn, err := grpc.DialContext(ctx, addr, grpc.WithInsecure(), grpc.WithContextDialer(dialer), grpc.WithDefaultCallOptions(grpc.MaxCallRecvMsgSize(maxMsgSize)))
 	if err != nil {
 		klog.Errorf("Connect remote runtime %s failed: %v", addr, err)
 		return nil, err
Index: containerd/services/server/server.go
===================================================================
--- containerd.orig/services/server/server.go
+++ containerd/services/server/server.go
@@ -58,7 +58,6 @@ import (
 	"google.golang.org/grpc"
 	"google.golang.org/grpc/backoff"
 	"google.golang.org/grpc/credentials"
-	"google.golang.org/grpc/credentials/insecure"
 )
 
 const (
@@ -561,7 +560,7 @@ func (pc *proxyClients) getClient(addres
 		Backoff: backoffConfig,
 	}
 	gopts := []grpc.DialOption{
-		grpc.WithTransportCredentials(insecure.NewCredentials()),
+		grpc.WithInsecure(),
 		grpc.WithConnectParams(connParams),
 		grpc.WithContextDialer(dialer.ContextDialer),
 
